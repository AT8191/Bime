# app.py
from fastapi import FastAPI, Request
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
import csv
import os
import smtplib
from email.message import EmailMessage

app = FastAPI()

# اجازه اتصال از فرانت (اگر میزبان جداست)
app.add_middleware(
  CORSMiddleware,
  allow_origins=["*"],
  allow_credentials=True,
  allow_methods=["*"],
  allow_headers=["*"],
)

CSV_FILE = "submissions.csv"

class Submission(BaseModel):
    insurance: str
    name: str
    phone: str
    description: str = ""
    extra: dict = {}

def ensure_csv():
    if not os.path.exists(CSV_FILE):
        with open(CSV_FILE, "w", newline="", encoding="utf-8") as f:
            writer = csv.writer(f)
            writer.writerow(["timestamp","insurance","name","phone","extra","description"])

@app.post("/api/submit")
async def submit(s: Submission):
    ensure_csv()
    import datetime
    ts = datetime.datetime.utcnow().isoformat()
    # save to csv
    with open(CSV_FILE, "a", newline="", encoding="utf-8") as f:
        writer = csv.writer(f)
        writer.writerow([ts, s.insurance, s.name, s.phone, str(s.extra), s.description])

    # optional: send email backup (configure below)
    try:
        SMTP_HOST = os.getenv("SMTP_HOST")      # e.g. smtp.gmail.com
        SMTP_PORT = int(os.getenv("SMTP_PORT", "587"))
        SMTP_USER = os.getenv("SMTP_USER")
        SMTP_PASS = os.getenv("SMTP_PASS")
        EMAIL_TO = os.getenv("EMAIL_TO")        # where to send notifications

        if SMTP_HOST and SMTP_USER and SMTP_PASS and EMAIL_TO:
            msg = EmailMessage()
            msg["Subject"] = f"درخواست بیمه — {s.insurance}"
            msg["From"] = SMTP_USER
            msg["To"] = EMAIL_TO
            body = f"""
درخواست جدید بیمه
نوع بیمه: {s.insurance}
نام: {s.name}
شماره: {s.phone}
اضافه: {s.extra}
توضیحات: {s.description}
"""
            msg.set_content(body)
            with smtplib.SMTP(SMTP_HOST, SMTP_PORT) as server:
                server.starttls()
                server.login(SMTP_USER, SMTP_PASS)
                server.send_message(msg)
    except Exception as e:
        # log but don't fail the request
        print("Email send failed:", e)

    # optional: integrate with SMS/WhatsApp provider here
    # e.g., call provider API with requests.post(...)

    return {"ok": True}
